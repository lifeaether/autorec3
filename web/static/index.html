<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>autorec - 番組表・録画管理</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav>
        <a href="/" class="logo">autorec</a>
        <a href="#" data-section="epg" class="active">番組表</a>
        <a href="epg.html">アーカイブ</a>
        <a href="#" data-section="rules">録画予約</a>
        <a href="#" data-section="schedules">録画予定</a>
        <a href="#" data-section="logs">ログ</a>
        <a href="#" data-section="help" style="margin-left:auto">ヘルプ</a>
    </nav>

    <main>
        <!-- 番組表セクション -->
        <div id="section-epg" class="section active">
            <h2>番組表</h2>
            <div class="toolbar">
                <input type="date" id="epg-date" onchange="loadEPG()">
                <select id="epg-channel" class="channel-select" onchange="loadEPG()">
                    <option value="">全チャンネル</option>
                </select>
            </div>
            <div class="card">
                <div id="epg-table" style="overflow-x:auto">
                    <p style="color:var(--text-muted)">読み込み中...</p>
                </div>
            </div>
        </div>

        <!-- 録画予約セクション -->
        <div id="section-rules" class="section">
            <h2>録画予約</h2>
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showRuleForm(null)">+ キーワード予約</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>予約名</th>
                            <th>キーワード</th>
                            <th>状態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="rules-table">
                        <tr><td colspan="5" style="text-align:center;color:var(--text-muted)">読み込み中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 録画予定セクション -->
        <div id="section-schedules" class="section">
            <h2>録画予定</h2>
            <div class="toolbar">
                <select id="schedule-status" onchange="loadSchedules()">
                    <option value="">全て</option>
                    <option value="scheduled">予定</option>
                    <option value="recording">録画中</option>
                    <option value="done">完了</option>
                    <option value="failed">失敗</option>
                    <option value="skipped">スキップ</option>
                </select>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>番組名</th>
                            <th>チャンネル</th>
                            <th>開始</th>
                            <th>終了</th>
                            <th>状態</th>
                            <th>予約名</th>
                        </tr>
                    </thead>
                    <tbody id="schedules-table">
                        <tr><td colspan="7" style="text-align:center;color:var(--text-muted)">読み込み中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ログセクション -->
        <div id="section-logs" class="section">
            <h2>録画ログ</h2>
            <div class="toolbar">
                <select id="log-level" onchange="loadLogs()">
                    <option value="">全て</option>
                    <option value="info">info</option>
                    <option value="warn">warn</option>
                    <option value="error">error</option>
                </select>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>日時</th>
                            <th>レベル</th>
                            <th>番組</th>
                            <th>チャンネル</th>
                            <th>メッセージ</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table">
                        <tr><td colspan="5" style="text-align:center;color:var(--text-muted)">読み込み中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- ヘルプセクション -->
        <div id="section-help" class="section">
            <h2>ヘルプ</h2>
            <div class="card">
                <h3 style="margin-bottom:0.5rem">画面の使い方</h3>
                <table>
                    <thead><tr><th>画面</th><th>説明</th></tr></thead>
                    <tbody>
                        <tr><td><strong>番組表</strong></td><td>日付・チャンネルを選んで番組一覧を表示します。番組をクリックすると詳細が表示され、そこから予約作成もできます。</td></tr>
                        <tr><td><strong>アーカイブ</strong></td><td>過去に取得した全番組データをキーワード・ジャンル・日付で検索できます。</td></tr>
                        <tr><td><strong>録画予約</strong></td><td>キーワード予約を管理します。キーワードに一致する番組が自動的に録画予定に登録されます。</td></tr>
                        <tr><td><strong>録画予定</strong></td><td>予約にマッチして録画予定に入った番組の一覧です。状態でフィルタできます。</td></tr>
                        <tr><td><strong>ログ</strong></td><td>録画の開始・完了・エラーなどの履歴です。</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="card">
                <h3 style="margin-bottom:0.5rem">録画の流れ</h3>
                <ol style="padding-left:1.5rem;line-height:2">
                    <li><strong>EPG取得</strong> — cron で定期実行 (1日2回) され、番組表データがDBに蓄積されます</li>
                    <li><strong>予約登録</strong> — 「キーワード予約」で自動録画条件を設定するか、番組表から番組を直接録画予定に追加します</li>
                    <li><strong>スケジュール生成</strong> — EPG取得後に自動実行され、予約に一致する番組が「録画予定」に登録されます</li>
                    <li><strong>録画実行</strong> — 番組開始の1分前に cron から自動的に録画が開始されます</li>
                    <li><strong>通知</strong> — 録画完了・失敗時に Discord 等で通知されます</li>
                </ol>
            </div>
            <div class="card">
                <h3 style="margin-bottom:0.5rem">予約方法</h3>
                <table>
                    <thead><tr><th>方法</th><th>説明</th><th>操作</th></tr></thead>
                    <tbody>
                        <tr><td><strong>キーワード予約</strong></td><td>キーワードに一致する番組を自動的に録画</td><td>「録画予約」→「+ キーワード予約」</td></tr>
                        <tr><td><strong>番組表から直接予約</strong></td><td>番組表で番組をクリックし、その番組を直接録画予定に追加</td><td>「番組表」→ 番組クリック →「この番組を録画する」</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="card">
                <h3 style="margin-bottom:0.5rem">キーワード予約の条件</h3>
                <table>
                    <thead><tr><th>項目</th><th>説明</th><th>例</th></tr></thead>
                    <tbody>
                        <tr><td>キーワード</td><td>番組タイトルの部分一致で自動録画</td><td>ニュース</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 番組詳細ポップアップ -->
    <div id="programme-detail" class="programme-detail"></div>

    <!-- キーワード予約 追加/編集モーダル -->
    <div id="rule-modal" class="modal-overlay">
        <div class="modal">
            <h3 id="rule-modal-title">キーワード予約</h3>
            <form id="rule-form" onsubmit="event.preventDefault(); saveRule();">
                <div class="form-group">
                    <label for="rule-name">予約名 *</label>
                    <input type="text" name="rule-name" id="rule-name" required placeholder="例: NHKニュース">
                </div>
                <div class="form-group">
                    <label for="rule-keyword">キーワード (部分一致)</label>
                    <input type="text" name="rule-keyword" id="rule-keyword" placeholder="番組タイトルで検索">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="rule-enabled" id="rule-enabled" checked>
                        有効
                    </label>
                </div>
                <div id="rule-preview" class="rule-preview" style="display:none">
                    <label>マッチする番組 (<span id="rule-preview-count">0</span>件)</label>
                    <div id="rule-preview-table"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('rule-modal').classList.remove('active')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/app.js"></script>
</body>
</html>
