<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>autorec - 番組表・録画管理</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav>
        <a href="/" class="logo">autorec</a>
        <a href="#" data-section="epg" class="active">番組表</a>
        <a href="epg.html">アーカイブ</a>
        <a href="#" data-section="rules">録画予約</a>
        <a href="#" data-section="schedules">録画予定</a>
        <a href="#" data-section="recordings">録画済み</a>
        <a href="#" data-section="live">ライブ</a>
        <a href="#" data-section="logs">ログ</a>
        <a href="#" data-section="help" style="margin-left:auto">ヘルプ</a>
    </nav>

    <main>
        <!-- 番組表セクション -->
        <div id="section-epg" class="section active">
            <h2>番組表</h2>
            <div class="toolbar">
                <input type="date" id="epg-date" onchange="loadEPG()">
                <select id="epg-channel" class="channel-select" onchange="loadEPG()">
                    <option value="">全チャンネル</option>
                </select>
                <select id="epg-category" onchange="loadEPG()">
                    <option value="">全ジャンル</option>
                </select>
            </div>
            <div class="card">
                <div id="epg-table" style="overflow-x:auto">
                    <p style="color:var(--text-muted)">読み込み中...</p>
                </div>
            </div>
        </div>

        <!-- 録画予約セクション -->
        <div id="section-rules" class="section">
            <h2>録画予約</h2>
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showRuleForm(null)">+ キーワード予約</button>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>予約名</th>
                            <th>キーワード</th>
                            <th>ジャンル</th>
                            <th>状態</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="rules-table">
                        <tr><td colspan="6" style="text-align:center;color:var(--text-muted)">読み込み中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 録画予定セクション -->
        <div id="section-schedules" class="section">
            <h2>録画予定</h2>
            <div class="toolbar">
                <select id="schedule-status" onchange="loadSchedules()">
                    <option value="">全て</option>
                    <option value="scheduled">予定</option>
                    <option value="recording">録画中</option>
                    <option value="done">完了</option>
                    <option value="failed">失敗</option>
                    <option value="skipped">スキップ</option>
                </select>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>番組名</th>
                            <th>チャンネル</th>
                            <th>開始</th>
                            <th>終了</th>
                            <th>状態</th>
                            <th>予約名</th>
                        </tr>
                    </thead>
                    <tbody id="schedules-table">
                        <tr><td colspan="7" style="text-align:center;color:var(--text-muted)">読み込み中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 録画済みセクション -->
        <div id="section-recordings" class="section">
            <h2>録画済みファイル</h2>
            <div class="toolbar">
                <input type="text" id="recordings-search" placeholder="シリーズ名・ファイル名で検索" oninput="filterRecordings()" style="min-width:250px">
            </div>
            <div id="recordings-list">
                <p style="color:var(--text-muted)">読み込み中...</p>
            </div>
        </div>

        <!-- ライブ視聴セクション -->
        <div id="section-live" class="section">
            <h2>ライブ視聴</h2>
            <div class="toolbar">
                <select id="live-channel" style="min-width:200px">
                    <option value="">チャンネルを選択</option>
                </select>
                <button id="live-start-btn" class="btn btn-primary" onclick="startLive()">視聴開始</button>
                <button id="live-stop-btn" class="btn btn-danger" onclick="stopLive()" style="display:none">停止</button>
                <span id="live-status" style="color:var(--text-muted);font-size:0.85rem"></span>
            </div>
            <div class="card" id="live-player-card" style="padding:0;overflow:hidden">
                <video id="live-video" controls autoplay style="width:100%;max-height:70vh;background:#000;display:block"></video>
            </div>
            <div id="live-now-playing" class="card" style="display:none">
                <h3 style="margin-bottom:0.5rem">放送中</h3>
                <div id="live-now-info"></div>
            </div>
            <div id="live-stream-info" style="font-size:0.8rem;color:var(--text-muted);margin-top:0.5rem"></div>
            <div id="live-error" style="color:var(--error);margin-top:0.5rem"></div>
        </div>

        <!-- ログセクション -->
        <div id="section-logs" class="section">
            <h2>録画ログ</h2>
            <div class="toolbar">
                <select id="log-level" onchange="loadLogs()">
                    <option value="">全て</option>
                    <option value="info">info</option>
                    <option value="warn">warn</option>
                    <option value="error">error</option>
                </select>
            </div>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>日時</th>
                            <th>レベル</th>
                            <th>番組</th>
                            <th>チャンネル</th>
                            <th>メッセージ</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table">
                        <tr><td colspan="5" style="text-align:center;color:var(--text-muted)">読み込み中...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- ヘルプセクション -->
        <div id="section-help" class="section">
            <h2>ヘルプ</h2>
            <div class="card">
                <h3 style="margin-bottom:0.5rem">画面の使い方</h3>
                <table>
                    <thead><tr><th>画面</th><th>説明</th></tr></thead>
                    <tbody>
                        <tr><td><strong>番組表</strong></td><td>日付・チャンネルを選んで番組一覧を表示します。番組をクリックすると詳細が表示され、そこから予約作成もできます。</td></tr>
                        <tr><td><strong>アーカイブ</strong></td><td>過去に取得した全番組データをキーワード・ジャンル・日付で検索できます。</td></tr>
                        <tr><td><strong>録画予約</strong></td><td>キーワード予約を管理します。キーワードに一致する番組が自動的に録画予定に登録されます。</td></tr>
                        <tr><td><strong>録画予定</strong></td><td>予約にマッチして録画予定に入った番組の一覧です。状態でフィルタできます。</td></tr>
                        <tr><td><strong>録画済み</strong></td><td>録画完了したファイルをシリーズ別に一覧表示します。ブラウザ内再生やダウンロードが可能です。</td></tr>
                        <tr><td><strong>ライブ</strong></td><td>放送中のテレビをリアルタイムで視聴します。チャンネルを選択して視聴開始をクリックすると、recpt1 経由でストリーミング再生が始まります。同時視聴は最大2ストリームです。</td></tr>
                        <tr><td><strong>ログ</strong></td><td>録画の開始・完了・エラーなどの履歴です。</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="card">
                <h3 style="margin-bottom:0.5rem">録画の流れ</h3>
                <ol style="padding-left:1.5rem;line-height:2">
                    <li><strong>EPG取得</strong> — cron で定期実行 (1日2回) され、番組表データがDBに蓄積されます</li>
                    <li><strong>予約登録</strong> — 「キーワード予約」で自動録画条件を設定するか、番組表から番組を直接録画予定に追加します</li>
                    <li><strong>スケジュール生成</strong> — EPG取得後に自動実行され、予約に一致する番組が「録画予定」に登録されます</li>
                    <li><strong>録画実行</strong> — 番組開始の1分前に cron から自動的に録画が開始されます</li>
                    <li><strong>通知</strong> — 録画完了・失敗時に Discord 等で通知されます</li>
                </ol>
            </div>
            <div class="card">
                <h3 style="margin-bottom:0.5rem">予約方法</h3>
                <table>
                    <thead><tr><th>方法</th><th>説明</th><th>操作</th></tr></thead>
                    <tbody>
                        <tr><td><strong>キーワード予約</strong></td><td>キーワードに一致する番組を自動的に録画</td><td>「録画予約」→「+ キーワード予約」</td></tr>
                        <tr><td><strong>番組表から直接予約</strong></td><td>番組表で番組をクリックし、その番組を直接録画予定に追加</td><td>「番組表」→ 番組クリック →「この番組を録画する」</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="card">
                <h3 style="margin-bottom:0.5rem">キーワード予約の条件</h3>
                <table>
                    <thead><tr><th>項目</th><th>説明</th><th>例</th></tr></thead>
                    <tbody>
                        <tr><td>キーワード</td><td>番組タイトルの部分一致で自動録画</td><td>ニュース</td></tr>
                        <tr><td>ジャンル</td><td>番組のジャンル (カテゴリ) で絞り込み</td><td>映画</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- 番組詳細ポップアップ -->
    <div id="programme-detail" class="programme-detail"></div>

    <!-- キーワード予約 追加/編集モーダル -->
    <div id="rule-modal" class="modal-overlay">
        <div class="modal">
            <h3 id="rule-modal-title">キーワード予約</h3>
            <form id="rule-form" onsubmit="event.preventDefault(); saveRule();">
                <div class="form-group">
                    <label for="rule-name">予約名 *</label>
                    <input type="text" name="rule-name" id="rule-name" required placeholder="例: NHKニュース">
                </div>
                <div class="form-group">
                    <label for="rule-keyword">キーワード (部分一致)</label>
                    <input type="text" name="rule-keyword" id="rule-keyword" placeholder="番組タイトルで検索">
                </div>
                <div class="form-group">
                    <label for="rule-category">ジャンル</label>
                    <select name="rule-category" id="rule-category">
                        <option value="">指定なし</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" name="rule-enabled" id="rule-enabled" checked>
                        有効
                    </label>
                </div>
                <div id="rule-preview" class="rule-preview" style="display:none">
                    <label>マッチする番組 (<span id="rule-preview-count">0</span>件)</label>
                    <div id="rule-preview-table"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('rule-modal').classList.remove('active')">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 動画再生モーダル -->
    <div id="video-modal" class="modal-overlay">
        <div class="modal" style="max-width:900px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.75rem">
                <h3 id="video-modal-title">再生</h3>
                <button class="btn btn-secondary btn-sm" onclick="closeRecordingPlayer(); document.getElementById('video-modal').classList.remove('active');">閉じる</button>
            </div>
            <video id="video-player" controls autoplay style="width:100%;max-height:70vh;background:#000"></video>
            <div id="video-seek-container" style="display:none;margin-top:0.5rem">
                <div style="display:flex;align-items:center;gap:0.5rem">
                    <span id="video-current-time" style="font-size:0.8rem;color:var(--text-muted);min-width:4em;text-align:right">0:00</span>
                    <input type="range" id="video-seek-bar" min="0" max="100" value="0" step="1" style="flex:1">
                    <span id="video-total-time" style="font-size:0.8rem;color:var(--text-muted);min-width:4em">0:00</span>
                </div>
            </div>
            <p style="font-size:0.75rem;color:var(--text-muted);margin-top:0.5rem">ffmpeg でトランスコードして再生しています。シークバーで任意の位置から再生できます。</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@1/dist/mpegts.js"></script>
    <script src="/app.js"></script>
</body>
</html>
