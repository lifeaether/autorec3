<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>autorec - 番組表アーカイブ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <nav>
        <!-- Desktop: Top bar -->
        <div class="nav-inner">
            <a href="/" class="logo">autorec</a>
            <div class="nav-tabs">
                <a href="/#live" class="nav-tab">ライブ</a>
                <a href="/#epg" class="nav-tab">番組表</a>
                <a href="/#recordings" class="nav-tab">録画済み</a>
            </div>
            <div class="nav-actions">
                <a href="/#rules" class="nav-link">録画ルール</a>
                <a href="/#schedules" class="nav-link">録画一覧</a>
                <a href="/#logs" class="nav-link">ログ</a>
                <a href="epg.html" class="nav-link active">アーカイブ</a>
                <a href="/#help" class="nav-link">ヘルプ</a>
            </div>
        </div>
        <!-- Mobile: Bottom bar -->
        <div class="nav-mobile">
            <a href="/#live" class="nav-primary">ライブ</a>
            <a href="/#epg" class="nav-primary">番組表</a>
            <a href="/#recordings" class="nav-primary">録画済み</a>
            <a href="/#rules" class="nav-primary">録画ルール</a>
            <a href="#" class="nav-primary nav-more-btn" onclick="toggleMoreDrawer(event)">メニュー</a>
        </div>
    </nav>
    <!-- Mobile more drawer -->
    <div id="more-drawer" class="more-drawer">
        <a href="epg.html" class="active">アーカイブ</a>
        <a href="/#schedules">録画一覧</a>
        <a href="/#logs">ログ</a>
        <a href="/#help">ヘルプ</a>
    </div>
    <div id="more-drawer-backdrop" class="more-drawer-backdrop" onclick="closeMoreDrawer()"></div>

    <main>
      <div class="content-wrapper">
        <h2>番組表アーカイブ</h2>

        <!-- 検索フォーム -->
        <div class="card">
            <form id="search-form" onsubmit="event.preventDefault(); searchProgrammes();">
                <div class="toolbar">
                    <input type="text" id="search-keyword" placeholder="キーワード検索" style="min-width:200px">
                    <select id="search-channel" class="channel-select">
                        <option value="">全チャンネル</option>
                    </select>
                    <select id="search-category">
                        <option value="">全ジャンル</option>
                    </select>
                    <input type="date" id="search-date-from">
                    <span style="color:var(--text-muted)">〜</span>
                    <input type="date" id="search-date-to">
                    <button type="submit" class="btn btn-primary">検索</button>
                </div>
            </form>
        </div>

        <!-- 統計情報 -->
        <div class="card" id="stats-card" style="display:none">
            <div style="display:flex;gap:2rem;flex-wrap:wrap">
                <div>
                    <span style="color:var(--text-muted);font-size:0.85rem">総番組数</span>
                    <div id="stat-total" style="font-size:1.5rem;font-weight:bold;color:var(--accent)">-</div>
                </div>
                <div>
                    <span style="color:var(--text-muted);font-size:0.85rem">期間</span>
                    <div id="stat-range" style="font-size:1rem">-</div>
                </div>
                <div>
                    <span style="color:var(--text-muted);font-size:0.85rem">チャンネル数</span>
                    <div id="stat-channels" style="font-size:1.5rem;font-weight:bold">-</div>
                </div>
            </div>
        </div>

        <!-- 検索結果 -->
        <div class="card">
            <div id="search-info" style="margin-bottom:0.5rem;font-size:0.85rem;color:var(--text-muted)"></div>
            <div id="archive-grid"></div>
            <div id="search-pagination" class="pagination"></div>
        </div>
      </div>
    </main>

    <!-- 番組詳細ポップアップ (app.js の showProgrammeDetail 用) -->
    <div id="programme-detail" class="programme-detail"></div>

    <script src="/app.js"></script>
    <script>
        let currentOffset = 0;
        const LIMIT = 2000;

        async function loadStats() {
            try {
                const data = await API.get('/api/programmes/stats');
                document.getElementById('stats-card').style.display = '';
                document.getElementById('stat-total').textContent = (data.total_programmes || 0).toLocaleString();
                document.getElementById('stat-range').textContent =
                    (data.earliest ? formatDate(data.earliest) : '?') + ' 〜 ' + (data.latest ? formatDate(data.latest) : '?');
                document.getElementById('stat-channels').textContent = (data.by_channel || []).length;
            } catch (e) {
                console.error('Stats load failed:', e);
            }
        }

        async function loadChannels() {
            try {
                const data = await API.get('/api/channels');
                const chList = data.channels || [];
                const sel = document.getElementById('search-channel');
                let opts = '<option value="">全チャンネル</option>';
                chList.forEach(ch => {
                    opts += `<option value="${escapeHtml(ch.name)}">${escapeHtml(ch.name)}</option>`;
                });
                sel.innerHTML = opts;
            } catch (e) {
                console.error('Channels load failed:', e);
            }
        }

        async function loadCategories() {
            try {
                const data = await API.get('/api/categories');
                const cats = data.categories || [];
                const sel = document.getElementById('search-category');
                let opts = '<option value="">全ジャンル</option>';
                cats.forEach(cat => {
                    opts += `<option value="${escapeHtml(cat)}">${escapeHtml(cat)}</option>`;
                });
                sel.innerHTML = opts;
            } catch (e) {
                console.error('Categories load failed:', e);
            }
        }

        async function searchProgrammes(offset) {
            currentOffset = offset || 0;
            const keyword = document.getElementById('search-keyword').value;
            const channel = document.getElementById('search-channel').value;
            const category = document.getElementById('search-category').value;
            const dateFrom = document.getElementById('search-date-from').value;
            const dateTo = document.getElementById('search-date-to').value;

            const params = new URLSearchParams();
            if (keyword) params.set('keyword', keyword);
            if (channel) params.set('channel', channel);
            if (category) params.set('category', category);
            if (dateFrom) params.set('date_from', dateFrom);
            if (dateTo) params.set('date_to', dateTo + ' 23:59:59');
            params.set('limit', LIMIT);
            params.set('offset', currentOffset);
            params.set('sort', 'asc');

            const container = document.getElementById('archive-grid');
            container.innerHTML = '<p style="color:var(--text-muted)">検索中...</p>';

            try {
                const data = await API.get('/api/programmes/search?' + params.toString());

                const info = document.getElementById('search-info');
                if (data.total === 0) {
                    info.textContent = '該当する番組がありません';
                    container.innerHTML = '<p style="color:var(--text-muted)">該当する番組がありません</p>';
                    document.getElementById('search-pagination').innerHTML = '';
                    return;
                }
                info.textContent = `${data.total.toLocaleString()} 件中 ${currentOffset + 1}〜${Math.min(currentOffset + LIMIT, data.total)} 件を表示`;

                renderEPGGrid(data.programmes, container, { showNowLine: false, autoScroll: false });

                // ページネーション
                const totalPages = Math.ceil(data.total / LIMIT);
                const currentPage = Math.floor(currentOffset / LIMIT);
                let paginationHtml = '';
                if (currentPage > 0) {
                    paginationHtml += `<button class="btn btn-secondary btn-sm" onclick="searchProgrammes(${(currentPage - 1) * LIMIT})">前へ</button>`;
                }
                paginationHtml += `<span style="color:var(--text-muted);font-size:0.85rem">${currentPage + 1} / ${totalPages}</span>`;
                if (currentPage < totalPages - 1) {
                    paginationHtml += `<button class="btn btn-secondary btn-sm" onclick="searchProgrammes(${(currentPage + 1) * LIMIT})">次へ</button>`;
                }
                document.getElementById('search-pagination').innerHTML = paginationHtml;
            } catch (err) {
                container.innerHTML = `<p style="color:var(--danger)">検索に失敗しました: ${escapeHtml(err.message)}</p>`;
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            loadChannels();
            loadCategories();
            loadStats();
        });
    </script>
</body>
</html>
